@model E_Commerce_Mezzex.Models.Domain.Product

@{
    ViewBag.Title = "Create Product";
}

<h2>Create Product</h2>

<style>
    .publish-status {
        margin-left: 5px;
    }
</style>



<ul class="nav nav-tabs" id="custom-tabs-three-tab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="custom-tabs-three-home-tab" data-toggle="pill" href="#custom-tabs-three-home" role="tab" aria-controls="custom-tabs-three-home" aria-selected="true">Product Details</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="custom-tabs-three-seo-tab" data-toggle="pill" href="#custom-tabs-three-seo" role="tab" aria-controls="custom-tabs-three-seo" aria-selected="false">SEO Information</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="custom-tabs-three-related-products-tab" data-toggle="pill" href="#custom-tabs-three-related-products" role="tab" aria-controls="custom-tabs-three-related-products" aria-selected="false">Related Products</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="custom-tabs-three-multimedia-tab" data-toggle="pill" href="#custom-tabs-three-multimedia" role="tab" aria-controls="custom-tabs-three-multimedia" aria-selected="false">Multimedia</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="custom-tabs-three-variations-tab" data-toggle="pill" href="#custom-tabs-three-variations" role="tab" aria-controls="custom-tabs-three-variations" aria-selected="false">Variations</a>
    </li>
</ul>

<form id="productForm" asp-action="AddProduct" method="post">
    <div class="tab-content mt-3" id="custom-tabs-three-tabContent">
        <div class="tab-pane fade show active" id="custom-tabs-three-home" role="tabpanel" aria-labelledby="custom-tabs-three-home-tab">
            <div class="form-group mb-3 mt-2 d-flex justify-content-end">
                <input type="submit" value="Add product" class="btn btn-primary btn-lg" />
            </div>
            <div class="form-group mb-3">
                <label asp-for="Name" class="control-label mb-2"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="ShortDescription" class="control-label mb-2"></label>
                <textarea asp-for="ShortDescription" class="form-control"></textarea>
                <span asp-validation-for="ShortDescription" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="FullDescription" class="control-label mb-2"></label>
                <textarea asp-for="FullDescription" id="content" class="form-control"></textarea>
                <span asp-validation-for="FullDescription" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="DisplayOrder" class="mb-2"></label>
                <input asp-for="DisplayOrder" class="form-control" />
                <span asp-validation-for="DisplayOrder" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="SKU" class="control-label mb-2"></label>
                <input asp-for="SKU" class="form-control"></input>
                <span asp-validation-for="SKU" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="Price" class="control-label mb-2"></label>
                <input asp-for="Price" class="form-control" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="CategoryId" class="control-label mb-2">Category</label>
                <select asp-for="CategoryId" class="form-control" multiple>
                    @foreach (var category in ViewBag.Categories)
                    {
                        <option value="@category.Value">@category.Text</option>
                    }
                </select>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="BrandId" class="control-label mb-2">Brand</label>
                <select asp-for="BrandId" class="form-control" asp-items="ViewBag.Brands"></select>
                <span asp-validation-for="BrandId" class="text-danger"></span>
            </div>
            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="NotReturnable" asp-for="NotReturnable" />
                <label for="NotReturnable" class="custom-control-label">Not Returnable</label>
                <span asp-validation-for="NotReturnable" class="text-danger"></span>
            </div>

            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="IsPublish" asp-for="IsPublish" />
                <label for="IsPublish" class="custom-control-label">Is Publish</label>
                <span asp-validation-for="IsPublish" class="text-danger"></span>
            </div>

            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="DisableBuyButton" asp-for="DisableBuyButton" />
                <label for="DisableBuyButton" class="custom-control-label">Disable Buy Button</label>
                <span asp-validation-for="DisableBuyButton" class="text-danger"></span>
            </div>

            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="DisableWishlistButton" asp-for="DisableWishlistButton" />
                <label for="DisableWishlistButton" class="custom-control-label">Disable Wishlist Button</label>
                <span asp-validation-for="DisableWishlistButton" class="text-danger"></span>
            </div>

            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="ShowOnHomePage" asp-for="ShowOnHomePage" />
                <label for="ShowOnHomePage" class="custom-control-label">Show On Home Page</label>
                <span asp-validation-for="ShowOnHomePage" class="text-danger"></span>
            </div>

            <div class="custom-control custom-checkbox">
                <input class="custom-control-input" type="checkbox" id="AllowCustomerReview" asp-for="AllowCustomerReview" />
                <label for="AllowCustomerReview" class="custom-control-label">Allow Customer Review</label>
                <span asp-validation-for="AllowCustomerReview" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="AvailableStartDateTimeUtc" class="control-label mb-2"></label>
                <input asp-for="AvailableStartDateTimeUtc" class="form-control" />
                <span asp-validation-for="AvailableStartDateTimeUtc" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="AvailableEndDateTimeUtc" class="control-label mb-2"></label>
                <input asp-for="AvailableEndDateTimeUtc" class="form-control" />
                <span asp-validation-for="AvailableEndDateTimeUtc" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="TagNames" class="control-label mb-2">Tags</label>
                <select class="form-control" multiple="multiple" asp-for="TagNames" id="tagsInput"></select>
                <span asp-validation-for="TagNames" class="text-danger"></span>
            </div>
        </div>
        <div class="tab-pane fade" id="custom-tabs-three-seo" role="tabpanel" aria-labelledby="custom-tabs-three-seo-tab">
            <div class="form-group mb-3">
                <label asp-for="MetaKeywords" class="control-label mb-2"></label>
                <input asp-for="MetaKeywords" class="form-control" />
                <span asp-validation-for="MetaKeywords" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="MetaDescription" class="control-label mb-2"></label>
                <textarea asp-for="MetaDescription" class="form-control"></textarea>
                <span asp-validation-for="MetaDescription" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="MetaTitle" class="control-label mb-2"></label>
                <input asp-for="MetaTitle" class="form-control" />
                <span asp-validation-for="MetaTitle" class="text-danger"></span>
            </div>
        </div>
        <div class="tab-pane fade" id="custom-tabs-three-related-products" role="tabpanel" aria-labelledby="custom-tabs-three-related-products-tab">
            <div class="form-group mb-3">
                <label class="control-label mb-2">Related Products</label>
                @if (ViewBag.RelatedProducts != null)
                {
                    <div class="card-body">
                        <div id="relatedProductsWrapper" class="dataTables_wrapper dt-bootstrap4">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table id="relatedProductsTable" class="table table-bordered table-hover" aria-describedby="relatedProductsInfo">
                                        <thead>
                                            <tr>
                                                <th>Select</th>
                                                <th>Product Name</th>
                                                <th>Publish Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var product in ViewBag.RelatedProducts)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="custom-control custom-checkbox">
                                                            <input type="checkbox" class="custom-control-input" id="customCheckbox_@product.Value" name="RelatedProductId" value="@product.Value" />
                                                            <label class="custom-control-label" for="customCheckbox_@product.Value"></label>
                                                        </div>
                                                    </td>
                                                    <td>@product.Text</td>
                                                    <td>
                                                        @if (product.Published)
                                                        {
                                                            <span class="publish-status text-success">✔</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="publish-status text-danger">✘</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th>Select</th>
                                                <th>Product Name</th>
                                                <th>Publish Status</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <p>No related products available</p>
                }
            </div>
        </div>


        <div class="tab-pane fade" id="custom-tabs-three-variations" role="tabpanel" aria-labelledby="custom-tabs-three-variations-tab">
            <div id="variationsContainer">
                <!-- Variations will be dynamically added here -->
            </div>
            <button type="button" id="addVariant" class="btn btn-success">Add Variant</button>
        </div>

        <div class="tab-pane fade" id="custom-tabs-three-multimedia" role="tabpanel" aria-labelledby="custom-tabs-three-multimedia-tab">
            <!-- Multimedia content will be dynamically added here after product is added -->
        </div>
    </div>
</form>
<div>
    <a asp-action="Index" class="btn btn-secondary mt-3  mb-3">Back to List</a>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/~/Admin/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
        $(document).ready(function () {
            // Initialize Froala Editor
            new FroalaEditor('#content', {
                imageUploadURL: '/api/images',
                heightMin: 200
            });
            $('#tagsInput').select2({
                tags: true,
                tokenSeparators: [',']
            });

            $('#CategoryId').select2({
                placeholder: 'Select Categories',
                allowClear: true
            });

            $('#productForm').on('submit', function (e) {
                e.preventDefault();

                if ($(this).data('submitted') === true) {
                    return;
                }

                $(this).data('submitted', true);

                // Check if required fields are filled
                if (!$('#Name').val()) {
                    Swal.fire('Error', 'Product Name is required', 'error');
                    $(this).data('submitted', false);
                    return;
                }

                var selectedRelatedProducts = [];
                $('input[name="RelatedProductId"]:checked').each(function () {
                    selectedRelatedProducts.push($(this).val());
                });
                var formData = $(this).serializeArray();
                formData.push({ name: "RelatedProductId", value: selectedRelatedProducts.join(',') });

                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: $.param(formData),
                    success: function (response) {
                        if (response.success) {
                            $('#productForm').append('<input type="hidden" id="productId" value="' + response.productId + '" />');
                            Swal.fire('Success', 'Product added successfully!', 'success').then(() => {
                                $('#custom-tabs-three-multimedia').html(`
                                                   <div class="form-group mb-3">
          <label for="multipleImageUpload">Upload Images</label>
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="multipleImageUpload" multiple>
            <label class="custom-file-label" for="multipleImageUpload">Choose files</label>
          </div>
        </div>

                                            <div class="form-group mb-3">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Image</th>
                                                            <th>SEO Filename</th>
                                                            <th>Alt Attribute</th>
                                                            <th>Title Attribute</th>
                                                            <th>URL</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="imageTableBody">
                                                        <!-- Images will be appended here -->
                                                    </tbody>
                                                </table>
                                                <button type="button" id="uploadAllImages" class="btn btn-primary">Save Images</button>
                                            </div>
                                        `);
                                $('#custom-tabs-three-multimedia-tab').tab('show');
                            });
                        } else {
                            Swal.fire('Error', response.message, 'error');
                        }
                        $('#productForm').data('submitted', false); // Allow form to be submitted again
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText); // Log the error response for debugging
                        Swal.fire('Error', 'An error occurred while adding the product.', 'error');
                        $('#productForm').data('submitted', false); // Allow form to be submitted again
                    }
                });
            });

            // Handle multimedia tab click
            $('#custom-tabs-three-multimedia-tab').on('click', function (e) {
                if (!$('#productId').val()) {
                    e.preventDefault();
                    Swal.fire('Warning', 'Please add the product first.', 'warning');
                    $('#custom-tabs-three-home-tab').tab('show');
                }
            });

            // Handle image upload
            $(document).on('change', '#multipleImageUpload', function () {
                handleImageUpload(this, $('#imageTableBody'));
            });

            // Handle image upload for variants
            $(document).on('change', '.variant-image-upload', function () {
                handleImageUpload(this, $(this).closest('.variant').find('.imageTableBody'));
            });

            function handleImageUpload(inputElement, imageTableBody) {
                let files = inputElement.files;
                let productId = $('#productId').val();
                for (let i = 0; i < files.length; i++) {
                    let data = new FormData();
                    data.append('file', files[i]);
                    data.append('productId', productId);

                    let mediaType = files[i].type.startsWith('image') ? 'Image' : (files[i].type.startsWith('video') ? 'Video' : 'Unknown');

                    $.ajax({
                        url: '/api/images',
                        type: 'POST',
                        processData: false,
                        contentType: false,
                        data: data,
                        success: function (result) {
                            let row = `
                                        <tr>
                                            <td>
                                                ${mediaType === 'Image' ? `<img src="${result.link}" style="width: 100px;" />` : `<video width="100" controls><source src="${result.link}" type="${files[i].type}"></video>`}
                                            </td>
                                            <td><input type="text" class="form-control seo-filename" /></td>
                                            <td><input type="text" class="form-control alt-attribute" /></td>
                                            <td><input type="text" class="form-control title-attribute" /></td>
                                            <td><input type="text" class="form-control media-type" value="${mediaType}" readonly></td>
                                            <td><input type="text" value="${result.link}" class="form-control image-url" readonly /></td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm delete-btn">Delete</button>
                                            </td>
                                        </tr>`;
                            imageTableBody.append(row);
                        },
                        error: function () {
                            Swal.fire('Error', 'Error uploading image.', 'error');
                        }
                    });
                }
            }

            // Handle deleting image row
            $(document).on('click', '.delete-btn', function () {
                $(this).closest('tr').remove();
            });

            $(document).on('click', '#uploadAllImages', function () {
                let imageDetails = [];
                $('#imageTableBody tr').each(function () {
                    let seoFilename = $(this).find('.seo-filename').val();
                    let altAttribute = $(this).find('.alt-attribute').val();
                    let titleAttribute = $(this).find('.title-attribute').val();
                    let mediaType = $(this).find('.media-type').val();
                    let imageUrl = $(this).find('.image-url').val();

                    imageDetails.push({
                        VirtualPath: imageUrl,
                        SeoFilename: seoFilename,
                        AltAttribute: altAttribute,
                        TitleAttribute: titleAttribute,
                        MediaType: mediaType,
                        ProductId: $('#productId').val()
                    });
                });

                $.ajax({
                    url: '/api/ImagesDetails',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(imageDetails),
                    success: function () {
                        Swal.fire('Success', 'Images saved successfully.', 'success').then(() => {
                            window.location.href = '/Products/Index';
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText); // Log the error response for debugging
                        Swal.fire('Error', 'Error saving images.', 'error');
                    }
                });
            });

            $('#relatedProductsTable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "language": {
                    "paginate": {
                        "previous": "Previous",
                        "next": "Next"
                    }
                },
                "order": [[1, 'asc']], // Default sorting on the second column (Product Name) in ascending order
                "columnDefs": [
                    { "orderable": true, "targets": [1] }, // Enable sorting on the Product Name column
                    { "orderable": false, "targets": [0, 2] } // Disable sorting on Select and Publish Status columns
                ]
            });
        });
    </script>
}

